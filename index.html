<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FearX Panel (Single File + Cfx Login)</title>
  <style>
    :root{--bg:#0f0f14;--panel:#11162a;--line:#1f2335;--muted:#94a3b8;--accent1:#2b3560;--accent2:#343a7e}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .grid{display:grid}.app{grid-template-columns:260px 1fr;min-height:100vh}
    aside{background:#0f1220;border-right:1px solid var(--line);padding:16px}
    .logo{font-weight:700;font-size:20px}.muted{color:var(--muted)}
    .nav a{display:flex;gap:10px;margin:6px 0;padding:10px 12px;border-radius:10px;color:#cbd5e1;text-decoration:none}
    .nav a:hover{background:#1b2032;color:#fff}.nav a.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line);background:#0f1220}
    main{padding:16px}.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px}
    .kpis{grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}.grid2{grid-template-columns:1fr 1fr;gap:16px}
    .table{width:100%;border-collapse:collapse}.table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    .input{background:#0f1220;border:1px solid var(--line);color:#e5e7eb;border-radius:8px;padding:8px 10px}
    .btn{background:#1f2335;border:1px solid #2a3151;color:#cbd5e1;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:hover{background:#2a3151;color:#fff}.hidden{display:none}.status{color:#4ade80}
    pre{background:#0f1220;padding:10px;border-radius:8px;overflow:auto}
    @media (max-width:980px){.app{grid-template-columns:1fr}aside{position:sticky;top:0;z-index:2}.kpis{grid-template-columns:1fr 1fr}.grid2{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="grid app">
    <aside>
      <div class="logo">FearX Panel</div>
      <div class="muted" style="font-size:13px">Single-file + Cfx login</div>
      <div style="border-top:1px solid var(--line);margin:12px 0 8px"></div>
      <nav class="nav">
        <a href="#/dashboard" data-view="dashboard" class="active">üìä Dashboard</a>
        <a href="#/logs" data-view="logs">üìú Live Logs</a>
        <a href="#/players" data-view="players">üë• Players</a>
        <a href="#/bans" data-view="bans">üö´ Bans</a>
        <a href="#/connect" data-view="connect">üîó Connect Server</a>
        <a href="#/login" data-view="login">üîê Login</a>
      </nav>
    </aside>
    <div>
      <header>
        <div>
          <div id="pageTitle" style="font-weight:600">Dashboard</div>
          <div class="muted" style="font-size:12px">Session: <span id="sessionStatus">Guest</span></div>
        </div>
        <div class="muted" style="font-size:13px">Server: <span id="serverName">‚Äî</span></div>
      </header>
      <main>
        <!-- DASHBOARD -->
        <section id="dashboard" class="view">
          <div class="grid kpis">
            <div class="card">
              <div class="muted" style="font-size:12px">Online Players</div>
              <div id="kpiOnline" style="font-size:28px;font-weight:700;margin-top:6px">0</div>
              <div class="muted" style="font-size:12px">of <span id="kpiMax">‚Äî</span></div>
            </div>
            <div class="card">
              <div class="muted" style="font-size:12px">Events (last 10)</div>
              <div id="kpiEvents" style="font-size:28px;font-weight:700;margin-top:6px">0</div>
              <div class="muted" style="font-size:12px">Live</div>
            </div>
            <div class="card">
              <div class="muted" style="font-size:12px">Status</div>
              <div style="font-size:28px;font-weight:700;margin-top:6px" class="status">Online</div>
              <div class="muted" style="font-size:12px">Realtime connected</div>
            </div>
            <div class="card">
              <div class="muted" style="font-size:12px">Panel</div>
              <div style="font-size:28px;font-weight:700;margin-top:6px">Single-file</div>
              <div class="muted" style="font-size:12px">Vercel static</div>
            </div>
          </div>
          <div class="grid grid2" style="margin-top:16px">
            <div class="card">
              <div style="font-weight:600">Recent Activity</div>
              <div id="recent" class="muted" style="margin-top:8px">Waiting for events‚Ä¶</div>
            </div>
            <div class="card">
              <div style="font-weight:600">Server Info</div>
              <div style="margin-top:8px">
                <div class="muted">Name: <span id="infoName">‚Äî</span></div>
                <div class="muted">Max: <span id="infoMax">‚Äî</span></div>
              </div>
            </div>
          </div>
        </section>

        <!-- LOGS -->
        <section id="logs" class="view hidden">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input class="input" id="logsQuery" placeholder="Filter by code or detail‚Ä¶" style="width:260px">
            <button class="btn" onclick="document.getElementById('logsQuery').value='';renderLogs()">Clear</button>
          </div>
          <div class="card" style="overflow:auto">
            <table class="table" id="logsTable">
              <thead class="muted"><tr><th>Time</th><th>Code</th><th>Severity</th><th>Server</th><th>Detail</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- PLAYERS -->
        <section id="players" class="view hidden">
          <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
            <input class="input" id="playersQuery" placeholder="Search by name or id‚Ä¶" style="width:260px">
            <div class="muted" id="playersCount" style="font-size:13px"></div>
          </div>
          <div class="grid grid2">
            <div class="card" style="max-height:70vh;overflow:auto">
              <table class="table" id="playersTable">
                <thead class="muted"><tr><th>Name</th><th>ID</</th><th>Trust</th><th>Last Seen</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="card"><div style="font-weight:600">Details</div><div class="muted" style="margin-top:8px">Select a player row.</div></div>
          </div>
        </section>

        <!-- BANS -->
        <section id="bans" class="view hidden">
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input class="input" id="bansQuery" placeholder="Search reason‚Ä¶" style="width:260px">
            <button class="btn" onclick="document.getElementById('bansQuery').value='';renderBans()">Clear</button>
          </div>
          <div class="card" style="overflow:auto">
            <table class="table" id="bansTable">
              <thead class="muted"><tr><th>Reason</th><th>Player ID</th><th>Created</th><th>By</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- CONNECT -->
        <section id="connect" class="view hidden">
          <div class="grid gap-3 max-w-2xl">
            <div class="text-2xl font-bold">Connect your server</div>
            <div class="muted">Generate a unique key ‚Üí paste in <code>server.cfg</code> ‚Üí your server heartbeats straight to Supabase REST. This page polls Supabase until it sees your key connected.</div>
            <div><button class="btn" id="genKeyBtn">Generate unique key</button></div>
            <div id="connectSteps" class="hidden card"></div>
          </div>
        </section>

        <!-- LOGIN -->
        <section id="login" class="view hidden">
          <div class="grid gap-3 max-w-xl">
            <div class="text-2xl font-bold">Login with Cfx.re</div>
            <div class="muted">You'll be redirected to <code>forum.cfx.re</code> to authorize "session info". We store a local session (masked key).</div>
            <div><button class="btn" id="cfxLoginBtn">Login with Cfx.re</button> <button class="btn" id="logoutBtn">Logout</button></div>
            <div class="card"><div style="font-weight:600">Status</div><div id="loginStatus" class="muted">Not signed in</div></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <script>
    // ===================== CONFIG =====================
    // Supabase (reads only via anon key)
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY";
    // Cfx.re Discourse user-api-key flow
    const CFX_CLIENT_ID = "YOUR_CFX_CLIENT_ID";
    const CFX_SCOPES = "session_info";
    const CFX_APP_NAME = "FearX Panel";
    // DB table names expected: players, events, bans, server_keys
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 5 }}});
    // ==================================================

    // Nav / views
    const links = document.querySelectorAll('a[data-view]');
    function goto(hashPath) {
      const v = (hashPath || location.hash || '#/dashboard').replace(/^#/, '');
      links.forEach(x=>x.classList.toggle('active', x.getAttribute('href') === '#'+v));
      document.getElementById('pageTitle').textContent = v.split('/')[1]?.replace(/\b\w/g,m=>m.toUpperCase()) || 'Dashboard';
      document.querySelectorAll('.view').forEach(s=>s.classList.add('hidden'));
      const id = v.slice(1);
      document.getElementById(id)?.classList.remove('hidden');
    }
    window.addEventListener('hashchange', ()=>goto());
    links.forEach(a => a.addEventListener('click', ()=>setTimeout(()=>goto(a.getAttribute('href')),0)));
    goto();

    // Session storage (client-only demo)
    function setSession(u, key) {
      const masked = key ? key.slice(0,4) + "‚Ä¢‚Ä¢‚Ä¢‚Ä¢" + key.slice(-4) : "";
      localStorage.setItem('fearx_session', JSON.stringify({ provider:'cfx', username:u||'cfx_user', masked }));
      updateSessionUI();
    }
    function clearSession(){ localStorage.removeItem('fearx_session'); updateSessionUI(); }
    function getSession(){ try { return JSON.parse(localStorage.getItem('fearx_session')||'null'); } catch(_) { return null; } }
    function updateSessionUI(){
      const s = getSession();
      document.getElementById('sessionStatus').textContent = s ? `Signed in as ${s.username}` : 'Guest';
      document.getElementById('loginStatus').textContent = s ? `Signed in as ${s.username} (key ${s.masked})` : 'Not signed in';
    }
    updateSessionUI();

    // Parse Cfx callback
    (function handleCfxCallback(){
      const p = new URLSearchParams(location.search);
      const key = p.get('user_api_key'); const user = p.get('username'); const nonce = p.get('nonce');
      const expected = localStorage.getItem('cfx_nonce');
      if (key && user && expected && expected === nonce){
        setSession(user, key);
        history.replaceState({}, "", location.pathname + location.hash);
      }
    })();

    // Login button
    document.getElementById('cfxLoginBtn').addEventListener('click', () => {
      const nonce = (Math.random().toString(36)+Math.random().toString(36)).slice(2, 10);
      localStorage.setItem('cfx_nonce', nonce);
      const base = "https://forum.cfx.re/user-api-key/new";
      const url = new URL(base);
      url.searchParams.set("client_id", CFX_CLIENT_ID);
      url.searchParams.set("scopes", CFX_SCOPES);
      url.searchParams.set("application_name", CFX_APP_NAME);
      url.searchParams.set("auth_redirect", location.origin + location.pathname + "#/login"); // return here
      url.searchParams.set("nonce", nonce);
      location.href = url.toString();
    });
    document.getElementById('logoutBtn').addEventListener('click', () => { clearSession(); alert("Logged out."); });

    // Data state
    let events = [], players = [], bans = [];
    const fmtTime = d => new Date(d).toLocaleTimeString();
    const timeAgo = d => { const diff=(Date.now()-new Date(d).getTime())/1000;
      if (diff<60) return Math.floor(diff)+"s ago"; if (diff<3600) return Math.floor(diff/60)+"m ago";
      if (diff<86400) return Math.floor(diff/3600)+"h ago"; return Math.floor(diff/86400)+"d ago"; };

    async function loadAll(){
      // Events
      let { data: ev } = await sb.from('events').select('*').order('created_at',{ascending:false}).limit(200);
      events = ev||[]; renderRecent(); renderLogs();
      const evCh = sb.channel('ev').on('postgres_changes',{event:'INSERT',schema:'public',table:'events'},p=>{
        events.unshift(p.new); if(events.length>500) events.pop(); renderRecent(); renderLogs();
      }).subscribe();
      // Players
      let { data: pl } = await sb.from('players').select('*').order('last_seen',{ascending:false}).limit(500);
      players = pl||[]; renderPlayers();
      const plCh = sb.channel('pl').on('postgres_changes',{event:'INSERT',schema:'public',table:'players'},()=>reloadPlayers())
        .on('postgres_changes',{event:'UPDATE',schema:'public',table:'players'},()=>reloadPlayers()).subscribe();
      // Bans
      let { data: bn } = await sb.from('bans').select('*').order('created_at',{ascending:false}).limit(200);
      bans = bn||[]; renderBans();
      const bnCh = sb.channel('bn').on('postgres_changes',{event:'INSERT',schema:'public',table:'bans'},p=>{bans.unshift(p.new); renderBans();}).subscribe();
      // Cosmetic server name
      document.getElementById('serverName').textContent = events[0]?.server_name || "‚Äî";
      document.getElementById('infoName').textContent = events[0]?.server_name || "‚Äî";
      document.getElementById('infoMax').textContent = "‚Äî"; document.getElementById('kpiMax').textContent = "‚Äî";
    }
    async function reloadPlayers(){ let { data: pl } = await sb.from('players').select('*').order('last_seen',{ascending:false}).limit(500); players = pl||[]; renderPlayers(); }

    function renderRecent(){
      const box = document.getElementById('recent');
      if(!events.length){ box.textContent='Waiting for events‚Ä¶'; return; }
      box.innerHTML = events.slice(0,10).map(e=>`
        <div style="display:grid;grid-template-columns:100px 1fr;gap:8px;border-bottom:1px solid var(--line);padding:6px 0">
          <div class="muted" style="font-size:12px">${fmtTime(e.created_at)}</div>
          <div><div style="font-weight:600">${e.code}</div><div class="muted" style="font-size:12px">${e.detail?JSON.stringify(e.detail):''}</div></div>
        </div>`).join('');
      document.getElementById('kpiEvents').textContent = Math.min(10, events.length);
    }
    function renderLogs(){
      const q=(document.getElementById('logsQuery').value||'').toLowerCase();
      const rows = events.filter(e=>!q || (e.code||'').toLowerCase().includes(q) || JSON.stringify(e.detail||{}).toLowerCase().includes(q));
      const tbody=document.querySelector('#logsTable tbody');
      tbody.innerHTML = rows.map(e=>`
        <tr><td class="muted">${timeAgo(e.created_at)}</td><td><strong>${e.code}</strong></td><td>${e.severity||''}</td><td>${e.server_name||''}</td><td>${e.detail?JSON.stringify(e.detail):''}</td></tr>`).join('');
    }
    function renderPlayers(){
      const q=(document.getElementById('playersQuery').value||'').toLowerCase();
      const rows = players.filter(p=>!q||(p.name||'').toLowerCase().includes(q)||String(p.id).includes(q));
      document.getElementById('playersCount').textContent = rows.length + ' results';
      const tbody=document.querySelector('#playersTable tbody');
      tbody.innerHTML = rows.map(p=>`
        <tr><td>${p.name||'Unknown'}</td><td>${p.id}</td><td>${p.trust_score ?? 0}</td><td class="muted">${p.last_seen?new Date(p.last_seen).toLocaleString():''}</td></tr>`).join('');
      document.getElementById('kpiOnline').textContent='0';
    }
    function renderBans(){
      const q=(document.getElementById('bansQuery').value||'').toLowerCase();
      const rows = bans.filter(b=>!q||(b.reason||'').toLowerCase().includes(q));
      const tbody=document.querySelector('#bansTable tbody');
      tbody.innerHTML = rows.map(b=>`
        <tr><td>${b.reason||'Banned'}</td><td>${b.player_id}</td><td class="muted">${new Date(b.created_at).toLocaleString()}</td><td class="muted">${b.created_by||''}</td></tr>`).join('');
    }
    document.getElementById('logsQuery').addEventListener('input', renderLogs);
    document.getElementById('playersQuery').addEventListener('input', renderPlayers);
    document.getElementById('bansQuery').addEventListener('input', renderBans);

    // Connect: generate key + poll Supabase for row {key,status:'connected'}
    const genBtn = document.getElementById('genKeyBtn');
    const stepsBox = document.getElementById('connectSteps');
    let currentKey = null, pollTimer = null;
    genBtn.addEventListener('click', () => {
      currentKey = (self.crypto?.randomUUID?.() || uuid.v4());
      stepsBox.classList.remove('hidden');
      stepsBox.innerHTML = `
        <div class="text-lg font-semibold mb-2">Step 1 ‚Äî Add to your server.cfg</div>
        <pre>setr fearx_server_key ${currentKey}
setr fearx_supabase_url ${SUPABASE_URL}
# store this on the server (do not share publicly)
setr fearx_supabase_service &lt;YOUR_SERVICE_ROLE_KEY&gt;</pre>
        <div class="text-lg font-semibold mt-4 mb-2">Step 2 ‚Äî Add heartbeat to a server resource</div>
        <pre>${luaSnippet(currentKey, SUPABASE_URL)}</pre>
        <div class="text-lg font-semibold mt-4 mb-2">Step 3 ‚Äî Restart server</div>
        <div class="muted">This panel is polling Supabase for your key‚Ä¶</div>
        <div class="mt-2">Status: <span id="connStatus" class="font-semibold">pending</span> <span id="connName"></span></div>
        <div id="connContinue" class="hidden" style="margin-top:10px"><a class="btn" href="#/dashboard">Continue ‚Üí</a></div>
      `;
      startPolling();
    });

    function luaSnippet(key, url){
      return `-- heartbeat to Supabase REST (runs every 60s)
CreateThread(function()
  local svc = GetConvar('fearx_supabase_service','')
  local k   = GetConvar('fearx_server_key','')
  local endpoint = '${url}/rest/v1/server_keys?on_conflict=key'
  if svc == '' or k == '' then
    print('^1[FearX] Missing fearx_supabase_service or fearx_server_key^0'); return
  end
  while true do
    local body = json.encode({
      key = k,
      status = 'connected',
      server_name = GetConvar('sv_hostname','My Server'),
      connected_at = os.date('!%Y-%m-%dT%H:%M:%SZ')
    })
    PerformHttpRequest(endpoint, function(code,res) print('[FearX] link status', code) end,
      'POST', body, {
        ['Content-Type']='application/json',
        ['apikey']=svc,
        ['Authorization']='Bearer '..svc,
        ['Prefer']='resolution=merge-duplicates,return=minimal'
      })
    Wait(60*1000)
  end
end)`;
    }

    function startPolling(){
      const statusEl = document.getElementById('connStatus');
      const nameEl = document.getElementById('connName');
      const cont = document.getElementById('connContinue');
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        const { data, error } = await sb.from('server_keys').select('*').eq('key', currentKey).limit(1);
        if (error) { console.log(error); return; }
        const row = (data||[])[0];
        if (!row) { statusEl.textContent = 'pending'; return; }
        statusEl.textContent = row.status || 'pending';
        nameEl.textContent = row.server_name ? '('+row.server_name+')' : '';
        if (row.status === 'connected') { cont.classList.remove('hidden'); clearInterval(pollTimer); }
      }, 3000);
    }

    // Kick off data
    loadAll();
  </script>
</body>
</html>
